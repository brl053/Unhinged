{
  "name": "Update Discord",
  "description": "Diagnose and update Discord when a new version is available. Uses rubric grading to ensure quality invoice before execution.",
  "tags": ["discord", "software-update", "apt", "dpkg"],
  "version": "1.0",
  "nodes": [
    {
      "id": "check_installed",
      "type": "unix",
      "command": "dpkg -l discord 2>/dev/null | grep -E '^ii' | awk '{print $3}' || echo 'not installed'"
    },
    {
      "id": "check_latest",
      "type": "unix",
      "command": "curl -sI 'https://discord.com/api/download?platform=linux&format=deb' | grep -i location | sed 's/.*discord-\\([0-9.]*\\).deb.*/\\1/' || echo 'unknown'"
    },
    {
      "id": "diagnose",
      "type": "llm",
      "config": {
        "model": "gpt-4o-mini",
        "system_prompt": "You are a Linux system administrator. Compare the installed version with the latest version. Output JSON with keys: needs_update (bool), diagnosis (string explaining what you found), citations (array of sources like man pages or URLs used).",
        "input_template": "Installed Discord version: {{check_installed.stdout}}\nLatest Discord version: {{check_latest.stdout}}\n\nDetermine if an update is needed and explain your diagnosis."
      }
    },
    {
      "id": "create_invoice",
      "type": "llm",
      "config": {
        "model": "gpt-4o-mini",
        "system_prompt": "You are a journeyman system administrator creating an invoice for work. Be professional and concise. Output JSON with keys: problem (restate issue), diagnosis (proof of work), citations (array - man pages, URLs, error codes), action (specific commands), risk (what could go wrong).",
        "input_template": "Based on this diagnosis:\n{{diagnose.stdout}}\n\nCreate an invoice for updating Discord on this Linux system. Include specific commands."
      }
    },
    {
      "id": "grade_invoice",
      "type": "rubric_grade",
      "config": {
        "rubric_name": "invoice_v1",
        "input_mapping": {
          "citations": "create_invoice.citations",
          "diagnosis": "create_invoice.diagnosis",
          "action": "create_invoice.action"
        }
      }
    },
    {
      "id": "present_invoice",
      "type": "user_input",
      "config": {
        "prompt": "Invoice ready. Execute update?",
        "options": ["yes", "no", "refine"]
      }
    },
    {
      "id": "download_discord",
      "type": "unix",
      "command": "cd /tmp && curl -L -o discord.deb 'https://discord.com/api/download?platform=linux&format=deb'"
    },
    {
      "id": "install_discord",
      "type": "unix",
      "command": "sudo dpkg -i /tmp/discord.deb || sudo apt-get install -f -y"
    },
    {
      "id": "verify_install",
      "type": "unix",
      "command": "dpkg -l discord | grep -E '^ii' && echo 'SUCCESS: Discord updated' || echo 'FAILED: Discord not updated'"
    },
    {
      "id": "cleanup",
      "type": "unix",
      "command": "rm -f /tmp/discord.deb"
    }
  ],
  "edges": [
    {"from": "check_installed", "to": "diagnose"},
    {"from": "check_latest", "to": "diagnose"},
    {"from": "diagnose", "to": "create_invoice"},
    {"from": "create_invoice", "to": "grade_invoice"},
    {"from": "grade_invoice", "to": "present_invoice", "condition": "grade_invoice['passed'] == true"},
    {"from": "grade_invoice", "to": "create_invoice", "condition": "grade_invoice['passed'] == false"},
    {"from": "present_invoice", "to": "download_discord", "condition": "present_invoice['selected_option'] == 0"},
    {"from": "download_discord", "to": "install_discord"},
    {"from": "install_discord", "to": "verify_install"},
    {"from": "verify_install", "to": "cleanup"}
  ]
}

