#!/bin/bash
# unhinged - Unified entry point for Unhinged dual-system architecture
# 
# @llm-type unified-entry-point
# @llm-legend Single entry point implementing cognitive command grouping for dual-system architecture
# @llm-key Provides normal user (Toyota) and power user (car enthusiast) experiences through progressive disclosure
# @llm-map Routes commands to appropriate subsystems while hiding implementation complexity
# @llm-axiom Entry points should teach system architecture through experience, not command options
# @llm-contract Respects user mental models: unified system for normal users, component awareness for power users
# @llm-token unhinged: unified entry point with cognitive command structure

set -e

# Project root detection
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get Python command from venv or system
get_python() {
    if [ -f "build/python/venv/bin/python" ]; then
        echo "build/python/venv/bin/python"
    else
        echo "python3"
    fi
}

# Logging functions
log_info() {
    echo -e "${CYAN}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Pre-flight check system
run_preflight_checks() {
    # Check if Python is available
    if ! command -v python3 &> /dev/null; then
        log_error "Python 3 not found - required for pre-flight checks"
        return 1
    fi

    # Run preflight checker (logs its own messages)
    if python3 "$PROJECT_ROOT/build/preflight_check.py" check; then
        return 0
    else
        log_warning "Pre-flight checks suggest restart for optimal experience"

        # Ask user if they want to force clean restart
        if [[ "${UNHINGED_AUTO_RESTART:-}" == "true" ]]; then
            log_info "Auto-restart enabled, forcing clean restart..."
            python3 "$PROJECT_ROOT/build/preflight_check.py" force-clean
            log_success "Clean restart preparation complete"
        else
            echo
            log_warning "Code changes detected. For optimal experience:"
            echo "  1. Kill any running desktop_app processes"
            echo "  2. Clear Python cache with: ./unhinged preflight clean"
            echo "  3. Or set UNHINGED_AUTO_RESTART=true for automatic handling"
            echo
        fi

        return 0  # Allow launch but with warning
    fi
}

# Help system
show_help() {
    cat << EOF
${CYAN}Unhinged${NC} - Native Graphics Platform with Dual-System Architecture

${YELLOW}USAGE:${NC}
  unhinged [COMMAND] [OPTIONS]
  unhinged                    # Default: start complete system (normal user)

${YELLOW}SYSTEM COMMANDS:${NC}
  start                       Start complete dual-system architecture
  stop                        Stop complete dual-system gracefully
  status                      Show system health and component status
  logs                        Stream system logs from all components
  restart                     Restart complete system (stop + start)

${YELLOW}DEVELOPMENT COMMANDS:${NC}
  dev                         Start development mode with enhanced tools
  dev-clean                   Clean development artifacts and caches
  dev-watch                   Watch files and rebuild on changes

${YELLOW}GRAPHICS COMMANDS:${NC}
  graphics build              Build native C graphics library
  graphics test               Run graphics test suite
  graphics run [app]          Run graphics application
  graphics clean              Clean graphics build artifacts

${YELLOW}BUILD COMMANDS:${NC}
  build list                  List available build targets
  build [target]              Build specific target
  build generate              Generate all design system artifacts
  build clean                 Clean build artifacts

${YELLOW}ADMIN COMMANDS:${NC}
  admin services list         List all running services
  admin services check        Health check all services
  admin cache clear           Clear all system caches
  admin reset                 Factory reset (removes all data)

${YELLOW}DEBUG COMMANDS:${NC}
  debug status                Show detailed system state
  debug logs [component]      Show component-specific logs

${YELLOW}VM COMMANDS:${NC}
  vm win10                    Launch Windows 10 gaming VM (350GB)
  vm templeos                 Launch TempleOS VM
  vm stop                     Stop running VM

${YELLOW}PREFLIGHT COMMANDS:${NC}
  preflight check             Run pre-flight checks for code changes
  preflight status            Show detailed preflight status
  preflight clean             Clean Python cache
  preflight force-clean       Force clean restart preparation
  preflight checksums         Manage code change detection

${YELLOW}LINTING COMMANDS:${NC}
  lint check [file]           Check file(s) for violations
  lint fix [file]             Auto-fix violations in file(s)
  lint format [file]          Format code with ruff
  lint hooks install          Install pre-commit hooks
  lint hooks run              Run all pre-commit hooks
  lint hooks run-file [file]  Run hooks on specific file
  lint rules                  Show all linting rules

${YELLOW}TESTING COMMANDS:${NC}
  test [pattern]              Run tests (all or matching pattern)

${YELLOW}SETUP COMMANDS:${NC}
  setup                       Install git hooks and dependencies

${YELLOW}GIT COMMANDS:${NC}
  commit "message"            Commit with validation (tests + lint)
  reset                       Nuclear reset (stop, clean, reset git)

${YELLOW}EXAMPLES:${NC}
  unhinged                    # Normal user: just start the system
  unhinged dev                # Power user: development mode
  unhinged graphics test      # Test graphics subsystem
  unhinged debug vm-shell     # Access VM for debugging

${YELLOW}MENTAL MODELS:${NC}
  ${GREEN}Normal User:${NC}     "There is one thing called Unhinged"
  ${BLUE}Power User:${NC}      "Components work together: GTK4 + Alpine VM + Services"

For more information, visit: https://github.com/brl053/Unhinged
EOF
}

# Command routing functions
cmd_start() {
    log_info "Starting Unhinged dual-system architecture..."
    cd "$PROJECT_ROOT"

    # Phase 0: Pre-flight checks (unless disabled)
    if [[ "${UNHINGED_SKIP_PREFLIGHT:-}" != "true" ]]; then
        run_preflight_checks
    else
        log_info "Pre-flight checks skipped (UNHINGED_SKIP_PREFLIGHT=true)"
    fi

    # Phase 1: Essential services via service launcher
    log_info "ðŸš€ Launching services..."
    local PYTHON_CMD=$(get_python)

    if $PYTHON_CMD control/service_launcher.py --timeout 120; then
        log_success "Essential services started"
    else
        log_warning "Some services failed to start - continuing with available services"
    fi

    # Phase 2: GUI and VM via existing Makefile
    log_info "ðŸŽ® Launching GUI..."
    exec make start-gui "$@"
}

cmd_stop() {
    log_info "Stopping Unhinged system gracefully..."
    cd "$PROJECT_ROOT"

    # Graceful shutdown sequence
    log_info "ðŸ›‘ Shutting down services..."
    python3 control/service_launcher.py --stop || log_warning "Some services may still be running"
    make down 2>/dev/null || true

    log_info "Stopping development services..."
    make dev-down 2>/dev/null || true

    log_info "Cleaning up processes..."
    pkill -f "python3.*desktop_app.py" 2>/dev/null || true
    pkill -f "unhinged" 2>/dev/null || true

    log_success "Unhinged system stopped gracefully"
}

cmd_status() {
    log_info "Checking Unhinged system status..."
    cd "$PROJECT_ROOT"

    # Service status via service launcher
    log_info "ðŸ“Š Service Status:"
    $(get_python) control/service_launcher.py --status

    # Overall system status via Makefile
    echo ""
    log_info "ðŸ–¥ï¸  System Status:"
    exec make status "$@"
}

cmd_logs() {
    log_info "Streaming system logs..."
    cd "$PROJECT_ROOT"
    exec make logs "$@"
}

cmd_restart() {
    log_info "Restarting Unhinged system..."
    cmd_stop
    sleep 2
    cmd_start "$@"
}

cmd_dev() {
    log_info "Starting development mode with enhanced tools..."
    cd "$PROJECT_ROOT"
    export DEV_MODE=1
    exec make dev "$@"
}

cmd_dev_clean() {
    log_info "Cleaning development artifacts..."
    cd "$PROJECT_ROOT"
    exec make clean "$@"
}

cmd_dev_watch() {
    log_info "Starting file watcher for continuous building..."
    cd "$PROJECT_ROOT"
    exec make watch "$@"
}

cmd_graphics() {
    local subcmd="${1:-help}"
    shift || true
    
    case "$subcmd" in
        build)
            log_info "Building native C graphics library..."
            cd "$PROJECT_ROOT"
            exec make graphics-build "$@"
            ;;
        test)
            log_info "Running graphics test suite..."
            cd "$PROJECT_ROOT"
            exec make graphics-hello-world "$@"
            ;;
        run)
            log_info "Running graphics application..."
            cd "$PROJECT_ROOT"
            exec make graphics-example "$@"
            ;;
        clean)
            log_info "Cleaning graphics build artifacts..."
            cd "$PROJECT_ROOT"
            exec make graphics-clean "$@"
            ;;
        help|*)
            echo "Graphics subsystem commands:"
            echo "  unhinged graphics build    Build graphics library"
            echo "  unhinged graphics test     Run graphics tests"
            echo "  unhinged graphics run      Run graphics application"
            echo "  unhinged graphics clean    Clean graphics artifacts"
            ;;
    esac
}

cmd_build() {
    local subcmd="${1:-help}"
    shift || true
    
    case "$subcmd" in
        list)
            log_info "Listing available build targets..."
            cd "$PROJECT_ROOT"
            exec make list "$@"
            ;;
        generate)
            log_info "Generating all design system artifacts..."
            cd "$PROJECT_ROOT"
            exec make generate "$@"
            ;;
        clean)
            log_info "Cleaning build artifacts..."
            cd "$PROJECT_ROOT"
            exec make clean "$@"
            ;;
        help|*)
            if [ "$subcmd" != "help" ] && [ -n "$subcmd" ]; then
                # Try to build specific target
                log_info "Building target: $subcmd"
                cd "$PROJECT_ROOT"
                exec make "$subcmd" "$@"
            else
                echo "Build system commands:"
                echo "  unhinged build list        List available targets"
                echo "  unhinged build [target]    Build specific target"
                echo "  unhinged build generate    Generate all artifacts"
                echo "  unhinged build clean       Clean build artifacts"
            fi
            ;;
    esac
}

cmd_admin() {
    local subcmd="${1:-help}"
    shift || true
    
    case "$subcmd" in
        services)
            local action="${1:-list}"
            shift || true
            case "$action" in
                list)
                    log_info "Listing running services..."
                    cd "$PROJECT_ROOT"
                    exec make service-status "$@"
                    ;;
                check)
                    log_info "Health checking all services..."
                    cd "$PROJECT_ROOT"
                    exec make health "$@"
                    ;;
                *)
                    echo "Service management commands:"
                    echo "  unhinged admin services list     List services"
                    echo "  unhinged admin services check    Health check"
                    ;;
            esac
            ;;
        cache)
            local action="${1:-help}"
            case "$action" in
                clear)
                    log_warning "Clearing all system caches..."
                    cd "$PROJECT_ROOT"
                    exec make clean "$@"
                    ;;
                *)
                    echo "Cache management commands:"
                    echo "  unhinged admin cache clear    Clear all caches"
                    ;;
            esac
            ;;
        reset)
            log_error "Factory reset will remove all data!"
            read -p "Are you sure? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                cd "$PROJECT_ROOT"
                exec make clean-all "$@"
            else
                log_info "Reset cancelled"
            fi
            ;;
        help|*)
            echo "Administration commands:"
            echo "  unhinged admin services list     List running services"
            echo "  unhinged admin services check    Health check services"
            echo "  unhinged admin cache clear       Clear all caches"
            echo "  unhinged admin reset             Factory reset (careful!)"
            ;;
    esac
}

cmd_debug() {
    local subcmd="${1:-help}"
    shift || true
    
    case "$subcmd" in
        status)
            log_info "Showing detailed system state..."
            cd "$PROJECT_ROOT"
            exec make status "$@"
            ;;
        logs)
            local component="${1:-all}"
            log_info "Showing logs for: $component"
            cd "$PROJECT_ROOT"
            exec make logs "$@"
            ;;
        help|*)
            echo "Debug commands:"
            echo "  unhinged debug status           Detailed system state"
            echo "  unhinged debug logs [comp]      Component logs"
            ;;
    esac
}

# VM command handler
cmd_vm() {
    local vm_type="${1:-help}"

    case "$vm_type" in
        win10)
            log_info "Launching Windows 10 gaming VM (350GB)..."
            log_info "Modeling host: AMD Ryzen 9 9950X, RTX 4090, 60GB RAM"
            log_info "Secure Boot: ENABLED (spoofed)"
            killall -9 qemu-system-x86_64 2>/dev/null || true
            sleep 2

            # Initialize OVMF firmware for Secure Boot support
            cp /usr/share/OVMF/OVMF_VARS_4M.fd /tmp/OVMF_VARS_win10.fd 2>/dev/null || log_warning "OVMF_VARS_4M.fd not found"

            qemu-system-x86_64 \
                -name "Windows-10" \
                -machine type=q35,accel=kvm,kernel-irqchip=on \
                -cpu host,+invtsc,+tsc,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_crash,hv_reset,hv_vpindex,hv_runtime \
                -smp cores=8,threads=1,sockets=1 \
                -m 16G \
                -device qemu-xhci,id=xhci \
                -device usb-tablet \
                -device VGA,vram=256 \
                -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE_4M.secboot.fd \
                -drive if=pflash,format=raw,file=/tmp/OVMF_VARS_win10.fd \
                -drive file="$PROJECT_ROOT/vm/bf6-w11-gaming.qcow2",if=virtio,format=qcow2,cache=writeback,discard=unmap \
                -drive file="$PROJECT_ROOT/build/tmp/Win10_22H2_English_x64v1.iso",media=cdrom,if=ide \
                -netdev user,id=net0,hostfwd=tcp::3389-:3389 -device virtio-net-pci,netdev=net0 \
                -enable-kvm \
                -display gtk \
                -boot order=c,menu=off &

            log_success "Windows 10 VM launched with Secure Boot enabled"
            ;;
        templeos)
            log_info "Launching TempleOS VM..."
            killall -9 qemu-system-x86_64 2>/dev/null || true
            sleep 2

            # Check if TempleOS disk exists, if so boot from it, otherwise boot from ISO
            if [ -f "$PROJECT_ROOT/vm/templeos.qcow2" ]; then
                log_info "Booting from existing TempleOS disk..."
                qemu-system-x86_64 \
                    -name TempleOS \
                    -machine type=pc,accel=kvm \
                    -cpu host \
                    -smp cores=4,threads=1,sockets=1 \
                    -m 2G \
                    -device VGA \
                    -drive file="$PROJECT_ROOT/vm/templeos.qcow2",if=ide,index=0,format=qcow2,cache=writeback \
                    -drive file="$PROJECT_ROOT/build/tmp/TempleOS.ISO",media=cdrom,if=ide,index=1 \
                    -netdev user,id=net0 -device e1000,netdev=net0 \
                    -enable-kvm \
                    -display gtk \
                    -boot order=c,menu=off &
            else
                log_info "No existing TempleOS disk found, booting from ISO..."
                qemu-system-x86_64 \
                    -name TempleOS \
                    -machine type=pc,accel=kvm \
                    -cpu host \
                    -smp cores=4,threads=1,sockets=1 \
                    -m 2G \
                    -device VGA \
                    -drive file="$PROJECT_ROOT/build/tmp/TempleOS.ISO",media=cdrom,if=ide,index=0 \
                    -netdev user,id=net0 -device e1000,netdev=net0 \
                    -enable-kvm \
                    -display gtk \
                    -boot order=d,menu=off &
            fi

            log_success "TempleOS VM launched"
            ;;
        stop)
            log_info "Stopping VM..."
            killall -9 qemu-system-x86_64 2>/dev/null && log_success "VM stopped" || log_warning "No VM running"
            ;;
        help|*)
            echo "VM commands:"
            echo "  unhinged vm win10       Launch Windows 10 gaming VM (350GB)"
            echo "  unhinged vm templeos    Launch TempleOS VM"
            echo "  unhinged vm stop        Stop running VM"
            ;;
    esac
}

# Preflight command handler
cmd_preflight() {
    local subcommand="${1:-check}"
    shift || true

    case "$subcommand" in
        check)
            log_info "Running preflight checks..."
            python3 "$PROJECT_ROOT/build/preflight_check.py" check
            ;;
        status)
            log_info "Showing preflight status..."
            python3 "$PROJECT_ROOT/build/preflight_check.py" status
            ;;
        clean)
            log_info "Cleaning Python cache..."
            python3 "$PROJECT_ROOT/build/preflight_check.py" clean
            ;;
        force-clean)
            log_info "Force cleaning and restarting..."
            python3 "$PROJECT_ROOT/build/preflight_check.py" force-clean
            ;;
        checksums)
            log_info "Managing checksums..."
            case "${1:-status}" in
                update)
                    shift
                    python3 "$PROJECT_ROOT/build/checksum_manager.py" update "$@"
                    ;;
                check)
                    shift
                    python3 "$PROJECT_ROOT/build/checksum_manager.py" check "$@"
                    ;;
                status)
                    shift
                    modules=("control/gtk4_gui" "control/gtk4_gui/controllers" "control/gtk4_gui/views" "build")
                    python3 "$PROJECT_ROOT/build/checksum_manager.py" status "${modules[@]}"
                    ;;
                force-update)
                    shift
                    modules=("control/gtk4_gui" "control/gtk4_gui/controllers" "control/gtk4_gui/views" "build")
                    python3 "$PROJECT_ROOT/build/checksum_manager.py" force-update "${modules[@]}"
                    ;;
                *)
                    echo "Checksum commands:"
                    echo "  unhinged preflight checksums status       Show checksum status"
                    echo "  unhinged preflight checksums check <mod>  Check module for changes"
                    echo "  unhinged preflight checksums update <mod> Update module checksums"
                    echo "  unhinged preflight checksums force-update Force update all"
                    ;;
            esac
            ;;
        help|*)
            echo "Preflight commands:"
            echo "  unhinged preflight check         Run preflight checks"
            echo "  unhinged preflight status        Show detailed status"
            echo "  unhinged preflight clean         Clean Python cache"
            echo "  unhinged preflight force-clean   Force clean restart"
            echo "  unhinged preflight checksums     Manage code checksums"
            ;;
    esac
}

# Linting command handler
cmd_lint() {
    local subcmd="${1:-help}"
    shift || true

    case "$subcmd" in
        check)
            local verbose=false
            if [ "$1" = "-v" ] || [ "$1" = "--verbose" ]; then
                verbose=true
                shift || true
            fi

            if [ -z "$1" ]; then
                log_info "Checking all Python files..."
                python3 "$PROJECT_ROOT/build/lint_summary.py" "$verbose"
            else
                log_info "Checking: $@"
                python3 build/lint.py "$@"
            fi
            ;;
        fix)
            if [ -z "$1" ]; then
                log_info "Auto-fixing all Python files..."
                ./build/python/venv/bin/ruff check --fix control/ libs/ --exclude build/python/venv
                log_success "Auto-fixed violations. Run 'lint check' to verify."
            else
                log_info "Auto-fixing: $@"
                ./build/python/venv/bin/ruff check --fix "$@"
            fi
            ;;
        format)
            if [ -z "$1" ]; then
                log_info "Formatting all Python files..."
                ./build/python/venv/bin/ruff format control/ libs/
            else
                log_info "Formatting: $@"
                ./build/python/venv/bin/ruff format "$@"
            fi
            ;;
        hooks)
            local action="${1:-help}"
            shift || true
            case "$action" in
                install)
                    log_info "Installing pre-commit hooks..."
                    ./build/python/venv/bin/pre-commit install
                    log_success "Pre-commit hooks installed"
                    ;;
                run)
                    log_info "Running all pre-commit hooks..."
                    ./build/python/venv/bin/pre-commit run --all-files
                    ;;
                run-file)
                    if [ -z "$1" ]; then
                        log_error "Please specify a file"
                        exit 1
                    fi
                    log_info "Running hooks on: $1"
                    ./build/python/venv/bin/pre-commit run --files "$1"
                    ;;
                *)
                    echo "Pre-commit hook commands:"
                    echo "  unhinged lint hooks install    Install hooks"
                    echo "  unhinged lint hooks run        Run all hooks"
                    echo "  unhinged lint hooks run-file   Run hooks on file"
                    ;;
            esac
            ;;
        rules)
            cat << 'RULES'
Linting Rules Enforced:

File Length:
  âš ï¸  WARNING: >500 lines
  âŒ FATAL: >1000 lines

Function Length:
  âš ï¸  WARNING: >50 lines
  âŒ FATAL: >100 lines

Function Branches (Complexity):
  âš ï¸  WARNING: >7 branches
  âŒ FATAL: >10 branches

Function Parameters:
  âš ï¸  WARNING: >5 parameters
  âŒ FATAL: >7 parameters

Class Size:
  âš ï¸  WARNING: >300 lines
  âŒ FATAL: >500 lines

Nesting Depth:
  âš ï¸  WARNING: >4 levels
  âŒ FATAL: >5 levels

Import Count:
  âš ï¸  WARNING: >20 statements
  âŒ FATAL: >25 statements

Wildcard Imports:
  âŒ FATAL: Always forbidden
RULES
            ;;
        help|*)
            echo "Linting commands:"
            echo "  unhinged lint check [-v] [file] Check file(s) for violations (-v for verbose)"
            echo "  unhinged lint fix [file]        Auto-fix violations"
            echo "  unhinged lint format [file]     Format code"
            echo "  unhinged lint hooks install     Install pre-commit hooks"
            echo "  unhinged lint hooks run         Run all hooks"
            echo "  unhinged lint hooks run-file    Run hooks on specific file"
            echo "  unhinged lint rules             Show all linting rules"
            ;;
    esac
}

# Test command handler
cmd_test() {
    local pattern="${1:-}"
    local PYTHON_CMD=$(get_python)

    if [ -z "$pattern" ]; then
        log_info "Running all tests..."
        local failed=0
        # Run individual test files to avoid import issues
        for test_file in control/gtk4_gui/tests/test_*.py; do
            if [ "$test_file" != "control/gtk4_gui/tests/test_components.py" ]; then
                echo ""
                log_info "Running: $(basename $test_file)"
                if ! $PYTHON_CMD "$test_file"; then
                    failed=$((failed + 1))
                fi
            fi
        done

        if [ $failed -gt 0 ]; then
            log_error "$failed test file(s) failed"
            return 1
        else
            log_success "All tests passed"
            return 0
        fi
    else
        log_info "Running tests matching: $pattern"
        local failed=0
        for test_file in control/gtk4_gui/tests/test_*.py; do
            if [[ "$test_file" == *"$pattern"* ]] && [ "$test_file" != "control/gtk4_gui/tests/test_components.py" ]; then
                if ! $PYTHON_CMD "$test_file"; then
                    failed=$((failed + 1))
                fi
            fi
        done

        if [ $failed -gt 0 ]; then
            log_error "$failed test file(s) failed"
            return 1
        else
            log_success "Tests passed"
            return 0
        fi
    fi
}

# Setup command handler
cmd_setup() {
    log_info "Setting up development environment..."

    log_info "ðŸ“¦ Installing pre-commit hooks..."
    ./build/python/venv/bin/pre-commit install
    log_success "Pre-commit hooks installed"

    log_info "ðŸ“¦ Installing Python dependencies..."
    ./build/python/venv/bin/pip install -q -r build/requirements-unified.txt
    log_success "Python dependencies installed"

    log_success "âœ… Setup complete! You're ready to develop."
    echo ""
    echo "Next steps:"
    echo "  1. Run tests: ./unhinged test"
    echo "  2. Check linting: ./unhinged lint check"
    echo "  3. Auto-fix issues: ./unhinged lint fix"
}

# Commit command handler
cmd_commit() {
    if [ -z "$1" ]; then
        log_error "Commit message required"
        echo "Usage: ./unhinged commit 'message'"
        exit 1
    fi

    log_info "Running pre-commit validation..."

    # Run tests
    log_info "ðŸ§ª Running tests..."
    if ! cmd_test; then
        log_error "Tests failed. Fix tests or use 'git commit' to bypass."
        return 1
    fi

    # Run linting check
    log_info "ðŸ“‹ Checking linting..."
    local lint_output=$(python3 build/lint_summary.py false 2>&1)
    if echo "$lint_output" | grep -q "FATAL"; then
        log_error "Fatal linting violations found. Fix or use 'git commit' to bypass."
        echo "$lint_output" | grep "FATAL"
        return 1
    fi

    # Commit
    log_info "ðŸ“ Committing..."
    git add -A
    git commit -m "$*"
    log_success "Committed: $*"
}

# Reset command handler
cmd_reset() {
    log_warning "âš ï¸  NUCLEAR RESET - This will:"
    echo "  - Kill all running processes"
    echo "  - Clear Python cache"
    echo "  - Reset git to HEAD"
    echo "  - Clean all build artifacts"
    echo ""
    read -p "Continue? (y/N): " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Stopping services..."
        cmd_stop 2>/dev/null || true

        log_info "Clearing Python cache..."
        python3 build/preflight_check.py force-clean 2>/dev/null || true

        log_info "Cleaning build artifacts..."
        make clean 2>/dev/null || true

        log_info "Resetting git..."
        git reset --hard HEAD

        log_success "âœ… Reset complete"
    else
        log_info "Reset cancelled"
    fi
}

# Main command dispatcher
main() {
    local command="${1:-start}"
    shift || true
    
    case "$command" in
        # System commands
        start)          cmd_start "$@" ;;
        stop)           cmd_stop "$@" ;;
        status)         cmd_status "$@" ;;
        logs)           cmd_logs "$@" ;;
        restart)        cmd_restart "$@" ;;
        
        # Development commands
        dev)            cmd_dev "$@" ;;
        dev-clean)      cmd_dev_clean "$@" ;;
        dev-watch)      cmd_dev_watch "$@" ;;
        dev-shell)      cmd_dev_shell "$@" ;;
        
        # Graphics commands
        graphics)       cmd_graphics "$@" ;;
        
        # Build commands
        build)          cmd_build "$@" ;;
        
        # Admin commands
        admin)          cmd_admin "$@" ;;
        
        # Debug commands
        debug)          cmd_debug "$@" ;;

        # VM commands
        vm)             cmd_vm "$@" ;;

        # Preflight commands
        preflight)      cmd_preflight "$@" ;;

        # Linting commands
        lint)           cmd_lint "$@" ;;

        # Testing commands
        test)           cmd_test "$@" ;;

        # Setup commands
        setup)          cmd_setup "$@" ;;

        # Git commands
        commit)         cmd_commit "$@" ;;
        reset)          cmd_reset "$@" ;;

        # Help and unknown commands
        help|--help|-h) show_help ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Execute main function with all arguments
main "$@"
