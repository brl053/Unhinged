# ============================================================================
# Unhinged Platforms - Makefile
# ============================================================================
#
# @file Makefile
# @version 1.0.0
# @author Unhinged Team
# @date 2025-10-19
# @description Build and deployment automation for all Unhinged platforms
#
# This Makefile provides convenient commands for building, testing, and
# deploying all platform-level services including persistence, agent,
# and workflow platforms.
#
# ============================================================================

.PHONY: help build test deploy clean start stop logs health

# Default target
help: ## Show this help message
	@echo "ğŸ—ï¸  Unhinged Platforms - Build & Deployment"
	@echo ""
	@echo "Available commands:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Platform-specific commands:"
	@echo "  make persistence-*     - Commands for persistence platform"
	@echo "  make agent-*           - Commands for agent platform (future)"
	@echo "  make workflow-*        - Commands for workflow platform (future)"

# ==========================================================================
# All Platforms Commands
# ==========================================================================

build: ## Build all platforms
	@echo "ğŸ”¨ Building all platforms..."
	@$(MAKE) persistence-build
	@echo "âœ… All platforms built successfully"

test: ## Test all platforms
	@echo "ğŸ§ª Testing all platforms..."
	@$(MAKE) persistence-test
	@echo "âœ… All platform tests completed"

start: ## Start all platforms with dependencies
	@echo "ğŸš€ Starting all platforms..."
	@docker-compose -f docker-compose.all.yml up -d
	@echo "âœ… All platforms started"
	@echo "ğŸŒ Persistence Platform: http://localhost:8090/api/v1"
	@echo "ğŸ“Š Grafana Dashboard: http://localhost:3000 (admin/admin)"
	@echo "ğŸ” Prometheus: http://localhost:9090"

stop: ## Stop all platforms
	@echo "ğŸ›‘ Stopping all platforms..."
	@docker-compose -f docker-compose.all.yml down
	@echo "âœ… All platforms stopped"

restart: stop start ## Restart all platforms

logs: ## Show logs for all platforms
	@docker-compose -f docker-compose.all.yml logs -f

health: ## Check health of all platforms
	@echo "ğŸ¥ Checking platform health..."
	@echo "Persistence Platform:"
	@curl -s http://localhost:8090/api/v1/health | jq '.' || echo "âŒ Persistence platform not responding"
	@echo ""

clean: ## Clean all platform resources
	@echo "ğŸ§¹ Cleaning all platform resources..."
	@docker-compose -f docker-compose.all.yml down -v --remove-orphans
	@docker system prune -f
	@echo "âœ… Cleanup completed"

# ==========================================================================
# Persistence Platform Commands
# ==========================================================================

persistence-build: ## Build persistence platform
	@echo "ğŸ”¨ Building persistence platform..."
	@cd persistence && ./gradlew clean build
	@cd persistence && docker build -t unhinged/persistence-platform:latest .
	@echo "âœ… Persistence platform built"

persistence-test: ## Test persistence platform
	@echo "ğŸ§ª Testing persistence platform..."
	@cd persistence && ./gradlew test integrationTest
	@echo "âœ… Persistence platform tests completed"

persistence-start: ## Start persistence platform only
	@echo "ğŸš€ Starting persistence platform..."
	@cd persistence && docker-compose up -d
	@echo "âœ… Persistence platform started"
	@echo "ğŸŒ API: http://localhost:8090/api/v1"

persistence-stop: ## Stop persistence platform
	@echo "ğŸ›‘ Stopping persistence platform..."
	@cd persistence && docker-compose down
	@echo "âœ… Persistence platform stopped"

persistence-logs: ## Show persistence platform logs
	@cd persistence && docker-compose logs -f

persistence-health: ## Check persistence platform health
	@echo "ğŸ¥ Checking persistence platform health..."
	@curl -s http://localhost:8090/api/v1/health | jq '.' || echo "âŒ Not responding"

persistence-metrics: ## Show persistence platform metrics
	@echo "ğŸ“Š Persistence platform metrics:"
	@curl -s http://localhost:8090/api/v1/metrics | head -20

persistence-shell: ## Open shell in persistence platform container
	@docker exec -it unhinged-persistence-platform /bin/bash

persistence-dev: ## Run persistence platform in development mode
	@echo "ğŸ”§ Starting persistence platform in development mode..."
	@cd persistence && ./gradlew dev

# ==========================================================================
# Future Platform Commands (Placeholders)
# ==========================================================================

agent-build: ## Build agent platform (future)
	@echo "âš ï¸  Agent platform not implemented yet"

agent-test: ## Test agent platform (future)
	@echo "âš ï¸  Agent platform not implemented yet"

agent-start: ## Start agent platform (future)
	@echo "âš ï¸  Agent platform not implemented yet"

workflow-build: ## Build workflow platform (future)
	@echo "âš ï¸  Workflow platform not implemented yet"

workflow-test: ## Test workflow platform (future)
	@echo "âš ï¸  Workflow platform not implemented yet"

workflow-start: ## Start workflow platform (future)
	@echo "âš ï¸  Workflow platform not implemented yet"

# ==========================================================================
# Development Commands
# ==========================================================================

dev-setup: ## Set up development environment
	@echo "ğŸ”§ Setting up development environment..."
	@echo "Installing development dependencies..."
	@cd persistence && ./gradlew build
	@echo "âœ… Development environment ready"

dev-start: ## Start all platforms in development mode
	@echo "ğŸ”§ Starting platforms in development mode..."
	@$(MAKE) persistence-dev &
	@echo "âœ… Development mode started"

format: ## Format all code
	@echo "ğŸ¨ Formatting code..."
	@cd persistence && ./gradlew ktlintFormat
	@echo "âœ… Code formatted"

lint: ## Lint all code
	@echo "ğŸ” Linting code..."
	@cd persistence && ./gradlew ktlintCheck
	@echo "âœ… Linting completed"

# ==========================================================================
# Monitoring Commands
# ==========================================================================

monitoring-start: ## Start monitoring stack only
	@echo "ğŸ“Š Starting monitoring stack..."
	@docker-compose -f docker-compose.all.yml up -d prometheus grafana jaeger
	@echo "âœ… Monitoring stack started"
	@echo "ğŸ“Š Grafana: http://localhost:3000 (admin/admin)"
	@echo "ğŸ” Prometheus: http://localhost:9090"
	@echo "ğŸ”— Jaeger: http://localhost:16686"

monitoring-stop: ## Stop monitoring stack
	@echo "ğŸ›‘ Stopping monitoring stack..."
	@docker-compose -f docker-compose.all.yml stop prometheus grafana jaeger
	@echo "âœ… Monitoring stack stopped"

# ==========================================================================
# Database Commands
# ==========================================================================

db-start: ## Start all databases
	@echo "ğŸ—„ï¸ Starting all databases..."
	@docker-compose -f docker-compose.all.yml up -d redis cockroachdb mongodb weaviate elasticsearch cassandra neo4j minio
	@echo "âœ… All databases started"

db-stop: ## Stop all databases
	@echo "ğŸ›‘ Stopping all databases..."
	@docker-compose -f docker-compose.all.yml stop redis cockroachdb mongodb weaviate elasticsearch cassandra neo4j minio
	@echo "âœ… All databases stopped"

db-reset: ## Reset all database data
	@echo "âš ï¸  This will delete all database data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(MAKE) stop
	@docker-compose -f docker-compose.all.yml down -v
	@echo "âœ… All database data reset"

# ==========================================================================
# Utility Commands
# ==========================================================================

status: ## Show status of all services
	@echo "ğŸ“Š Platform Status:"
	@docker-compose -f docker-compose.all.yml ps

ps: status ## Alias for status

top: ## Show resource usage
	@docker stats --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

images: ## Show platform images
	@echo "ğŸ³ Platform Images:"
	@docker images | grep -E "(unhinged|redis|cockroach|mongo|weaviate|elastic|cassandra|neo4j|minio|prometheus|grafana|jaeger)"

volumes: ## Show platform volumes
	@echo "ğŸ’¾ Platform Volumes:"
	@docker volume ls | grep -E "(redis|cockroach|mongo|weaviate|elastic|cassandra|neo4j|minio|prometheus|grafana)"

networks: ## Show platform networks
	@echo "ğŸŒ Platform Networks:"
	@docker network ls | grep unhinged

# ==========================================================================
# Documentation Commands
# ==========================================================================

docs: ## Generate documentation
	@echo "ğŸ“š Generating documentation..."
	@cd persistence && ./gradlew generateApiDocs
	@echo "âœ… Documentation generated"

docs-serve: ## Serve documentation locally
	@echo "ğŸ“š Serving documentation..."
	@echo "âš ï¸  Documentation server not implemented yet"

# ==========================================================================
# Release Commands
# ==========================================================================

release-prepare: ## Prepare release
	@echo "ğŸ“¦ Preparing release..."
	@$(MAKE) clean
	@$(MAKE) build
	@$(MAKE) test
	@echo "âœ… Release preparation completed"

release-build: ## Build release artifacts
	@echo "ğŸ“¦ Building release artifacts..."
	@$(MAKE) persistence-build
	@echo "âœ… Release artifacts built"

# ==========================================================================
# CI/CD Commands
# ==========================================================================

ci-test: ## Run CI tests
	@echo "ğŸ¤– Running CI tests..."
	@$(MAKE) build
	@$(MAKE) test
	@$(MAKE) lint
	@echo "âœ… CI tests completed"

ci-deploy: ## Deploy for CI/CD
	@echo "ğŸš€ Deploying for CI/CD..."
	@$(MAKE) release-build
	@echo "âœ… CI/CD deployment completed"
