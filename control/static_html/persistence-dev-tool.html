<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Persistence Platform Dev Tool</title>
    <link rel="stylesheet" href="shared/theme.css">
    <script src="shared/components.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
        <!-- Page Header - DRY Component -->
        <div id="header-container" data-component="page-header"
             data-title="Data Management"
             data-subtitle="Persistence Platform Development Tool"
             data-icon="üíæ"></div>
            <div class="header-controls">
                <span id="lastUpdate">Last Update: --</span>
                <button onclick="refreshPlatformStatus()">üîÑ Refresh</button>
            </div>
        </header>

        <!-- Navigation - DRY Component -->
        <div id="nav-container" data-component="navigation" data-active="persistence"></div>

        <!-- Platform Status -->
        <section class="status-section">
            <h2>üìä Platform Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="label">Health:</span>
                    <span id="platform-health" class="value">--</span>
                </div>
                <div class="status-item">
                    <span class="label">Version:</span>
                    <span id="platform-version" class="value">--</span>
                </div>
                <div class="status-item">
                    <span class="label">Uptime:</span>
                    <span id="platform-uptime" class="value">--</span>
                </div>
                <div class="status-item">
                    <span class="label">Technologies:</span>
                    <span id="platform-technologies" class="value">--</span>
                </div>
            </div>
        </section>

        <!-- Operations -->
        <section class="operations-section">
            <h2>üîß Operations</h2>
            
            <!-- Insert Record -->
            <div class="operation-card">
                <div class="operation-header">
                    <h3>‚ûï Insert Record</h3>
                    <button onclick="executeInsert()">Execute</button>
                </div>
                <div class="form-group">
                    <label>Table Name:</label>
                    <input type="text" id="insert-table" value="users" placeholder="users">
                </div>
                <div class="form-group">
                    <label>Record Data (JSON):</label>
                    <textarea id="insert-data" rows="4" placeholder='{"email": "user@example.com"}'>{
  "email": "user@example.com",
  "profile": {
    "name": "John Doe",
    "age": 30
  }
}</textarea>
                </div>
                <div class="result-section" id="insert-result" style="display: none;">
                    <div class="result-header">
                        <span>Response:</span>
                        <span id="insert-status" class="status">--</span>
                    </div>
                    <pre id="insert-body" class="result-body"></pre>
                </div>
            </div>

            <!-- Execute Query -->
            <div class="operation-card">
                <div class="operation-header">
                    <h3>üîç Execute Query</h3>
                    <button onclick="executeQuery()">Execute</button>
                </div>
                <div class="form-group">
                    <label>Query Name:</label>
                    <input type="text" id="query-name" value="get_user_by_id" placeholder="get_user_by_id">
                </div>
                <div class="form-group">
                    <label>Parameters (JSON):</label>
                    <textarea id="query-params" rows="3" placeholder='{"user_id": "123"}'>{
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "active"
}</textarea>
                </div>
                <div class="result-section" id="query-result" style="display: none;">
                    <div class="result-header">
                        <span>Response:</span>
                        <span id="query-status" class="status">--</span>
                    </div>
                    <pre id="query-body" class="result-body"></pre>
                </div>
            </div>

            <!-- Vector Search -->
            <div class="operation-card">
                <div class="operation-header">
                    <h3>üéØ Vector Search</h3>
                    <button onclick="executeVectorSearch()">Execute</button>
                </div>
                <div class="form-group">
                    <label>Table Name:</label>
                    <input type="text" id="vector-table" value="document_embeddings" placeholder="document_embeddings">
                </div>
                <div class="form-group">
                    <label>Query Vector (JSON Array):</label>
                    <textarea id="vector-query" rows="2">[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8]</textarea>
                </div>
                <div class="form-group">
                    <label>Limit:</label>
                    <input type="number" id="vector-limit" value="10" min="1" max="100">
                </div>
                <div class="result-section" id="vector-result" style="display: none;">
                    <div class="result-header">
                        <span>Response:</span>
                        <span id="vector-status" class="status">--</span>
                    </div>
                    <pre id="vector-body" class="result-body"></pre>
                </div>
            </div>

            <!-- Raw API Call -->
            <div class="operation-card">
                <div class="operation-header">
                    <h3>üåê Raw API Call</h3>
                    <button onclick="executeRawAPI()">Execute</button>
                </div>
                <div class="form-group">
                    <label>Method:</label>
                    <select id="raw-method">
                        <option value="GET">GET</option>
                        <option value="POST" selected>POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Endpoint:</label>
                    <input type="text" id="raw-endpoint" value="/api/v1/health" placeholder="/api/v1/health">
                </div>
                <div class="form-group">
                    <label>Request Body (JSON):</label>
                    <textarea id="raw-body" rows="3" placeholder='{"key": "value"}'></textarea>
                </div>
                <div class="result-section" id="raw-result" style="display: none;">
                    <div class="result-header">
                        <span>Response:</span>
                        <span id="raw-status" class="status">--</span>
                    </div>
                    <pre id="raw-body-result" class="result-body"></pre>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>üèóÔ∏è Persistence Platform Dev Tool - Platform URL: <code>http://localhost:8090</code></p>
        </footer>
    </div>

    <script>
        const PLATFORM_BASE_URL = 'http://localhost:8090';
        
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            refreshPlatformStatus();
        });
        
        function updateTimestamp() {
            const now = new Date().toLocaleString();
            document.getElementById('lastUpdate').textContent = `Last Update: ${now}`;
        }
        
        async function refreshPlatformStatus() {
            updateTimestamp();
            
            try {
                const response = await fetch(`${PLATFORM_BASE_URL}/api/v1/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('platform-health').textContent = data.healthy ? 'üü¢ Healthy' : 'üî¥ Unhealthy';
                    document.getElementById('platform-version').textContent = data.version || '--';
                    document.getElementById('platform-uptime').textContent = data.uptime_seconds ? `${Math.floor(data.uptime_seconds / 60)}m` : '--';
                    
                    if (data.technology_health) {
                        const healthyCount = data.technology_health.filter(t => t.healthy).length;
                        const totalCount = data.technology_health.length;
                        document.getElementById('platform-technologies').textContent = `${healthyCount}/${totalCount}`;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('Platform not available, using mock data:', error.message);
                document.getElementById('platform-health').textContent = 'üü° Mock Mode';
                document.getElementById('platform-version').textContent = '1.0.0-mock';
                document.getElementById('platform-uptime').textContent = '0m';
                document.getElementById('platform-technologies').textContent = '0/8';
            }
        }
        
        async function makeAPICall(endpoint, options = {}) {
            try {
                const response = await fetch(`${PLATFORM_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                console.warn('API call failed, using mock response:', error.message);
                return getMockResponse(endpoint, options);
            }
        }
        
        function getMockResponse(endpoint, options) {
            if (endpoint.includes('/tables/')) {
                return {
                    success: true,
                    data: {
                        success: true,
                        record: {
                            id: 'mock-' + Date.now(),
                            data: JSON.parse(options.body || '{}'),
                            created_at: new Date().toISOString()
                        },
                        execution_time_ms: 45
                    }
                };
            } else if (endpoint.includes('/query/')) {
                return {
                    success: true,
                    data: {
                        success: true,
                        results: [{
                            id: 'mock-user-123',
                            data: { email: 'mock@example.com', profile: { name: 'Mock User' } },
                            created_at: new Date().toISOString()
                        }],
                        count: 1,
                        execution_time_ms: 120,
                        from_cache: false
                    }
                };
            } else if (endpoint.includes('/vector/search/')) {
                return {
                    success: true,
                    data: {
                        success: true,
                        results: [{
                            record: { id: 'mock-doc-1', data: { title: 'Mock Document' } },
                            similarity_score: 0.95,
                            distance: 0.05
                        }],
                        execution_time_ms: 200
                    }
                };
            } else {
                return {
                    success: false,
                    data: { error: 'Platform unavailable - mock mode active' }
                };
            }
        }
        
        function showResult(operationType, success, data) {
            const resultDiv = document.getElementById(`${operationType}-result`);
            const statusSpan = document.getElementById(`${operationType}-status`);
            const bodyPre = document.getElementById(`${operationType}-body`);
            
            resultDiv.style.display = 'block';
            statusSpan.textContent = success ? '‚úÖ Success' : '‚ùå Error';
            statusSpan.className = `status ${success ? 'success' : 'error'}`;
            bodyPre.textContent = JSON.stringify(data, null, 2);
        }
        
        async function executeInsert() {
            const table = document.getElementById('insert-table').value;
            const dataText = document.getElementById('insert-data').value;
            
            try {
                const data = JSON.parse(dataText);
                const result = await makeAPICall(`/api/v1/tables/${table}`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showResult('insert', result.success, result.data);
            } catch (error) {
                showResult('insert', false, { error: error.message });
            }
        }
        
        async function executeQuery() {
            const queryName = document.getElementById('query-name').value;
            const paramsText = document.getElementById('query-params').value;
            
            try {
                const parameters = JSON.parse(paramsText);
                const result = await makeAPICall(`/api/v1/query/${queryName}`, {
                    method: 'POST',
                    body: JSON.stringify({ parameters })
                });
                showResult('query', result.success, result.data);
            } catch (error) {
                showResult('query', false, { error: error.message });
            }
        }
        
        async function executeVectorSearch() {
            const table = document.getElementById('vector-table').value;
            const vectorText = document.getElementById('vector-query').value;
            const limit = parseInt(document.getElementById('vector-limit').value);
            
            try {
                const queryVector = JSON.parse(vectorText);
                const result = await makeAPICall(`/api/v1/vector/search/${table}`, {
                    method: 'POST',
                    body: JSON.stringify({ queryVector, limit, threshold: 0.7 })
                });
                showResult('vector', result.success, result.data);
            } catch (error) {
                showResult('vector', false, { error: error.message });
            }
        }
        
        async function executeRawAPI() {
            const method = document.getElementById('raw-method').value;
            const endpoint = document.getElementById('raw-endpoint').value;
            const bodyText = document.getElementById('raw-body').value;
            
            try {
                const options = { method };
                if (bodyText.trim() && method !== 'GET') {
                    options.body = bodyText;
                }
                
                const result = await makeAPICall(endpoint, options);
                showResult('raw', result.success, result.data);
            } catch (error) {
                showResult('raw', false, { error: error.message });
            }
        }
    </script>

    <!-- Footer - DRY Component -->
    <div id="footer-container" data-component="footer"></div>
</body>
</html>
