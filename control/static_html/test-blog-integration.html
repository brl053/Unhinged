<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Blog Integration Test</title>
    <link rel="stylesheet" href="shared/theme.css">
    <link rel="stylesheet" href="shared/styles.css">
    <script src="shared/config.js"></script>
    <script src="../generated/static_html/registry.js"></script>
    <script src="shared/components.js"></script>
    <script src="../generated/static_html/api-clients.js"></script>
    <script src="shared/api-integration.js"></script>
    <script src="shared/persistence-client.js"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-xl, 24px);
        }

        .test-section {
            background: var(--color-background, white);
            border: 2px solid var(--color-border, #dee2e6);
            border-radius: var(--border-radius-lg, 12px);
            padding: var(--spacing-xl, 24px);
            margin-bottom: var(--spacing-xl, 24px);
            box-shadow: var(--shadow, 0 2px 8px rgba(0,0,0,0.1));
        }

        .test-title {
            font-size: var(--font-size-lg, 1.125rem);
            font-weight: 600;
            color: var(--color-text-primary, #212529);
            margin-bottom: var(--spacing-md, 16px);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm, 8px);
        }

        .test-button {
            padding: var(--spacing-md, 12px) var(--spacing-lg, 20px);
            background: var(--color-primary, #2563eb);
            color: white;
            border: none;
            border-radius: var(--border-radius, 8px);
            font-size: var(--font-size-base, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition, 150ms ease);
            margin-right: var(--spacing-md, 12px);
            margin-bottom: var(--spacing-sm, 8px);
        }

        .test-button:hover {
            background: var(--color-primary-dark, #1d4ed8);
        }

        .test-button:disabled {
            background: var(--color-text-secondary, #6c757d);
            cursor: not-allowed;
        }

        .test-result {
            background: var(--color-surface, #f8f9fa);
            border: 1px solid var(--color-border, #dee2e6);
            border-radius: var(--border-radius, 8px);
            padding: var(--spacing-md, 16px);
            margin-top: var(--spacing-md, 16px);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: var(--font-size-sm, 14px);
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-result.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--color-success, #10b981);
            color: var(--color-success-dark, #059669);
        }

        .test-result.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-error, #ef4444);
            color: var(--color-error-dark, #dc2626);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: var(--spacing-xs, 4px);
        }

        .status-indicator.success {
            background: var(--color-success, #10b981);
        }

        .status-indicator.error {
            background: var(--color-error, #ef4444);
        }

        .status-indicator.pending {
            background: var(--color-warning, #f59e0b);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div id="nav-container" data-component="navigation" data-active="test"></div>

        <!-- Page Header -->
        <div id="header-container" data-component="page-header"></div>

        <main class="test-container" id="main-content">
            <h1>üß™ Blog Integration Test</h1>
            <p>Test the blog editor and persistence platform integration with CockroachDB.</p>

            <!-- Persistence Client Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="client-status" class="status-indicator pending"></span>
                    <span>Persistence Client Connection</span>
                </h2>
                <p>Test connection to the persistence platform client.</p>
                <button class="test-button" onclick="testPersistenceClient()">Test Client Connection</button>
                <div id="client-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Health Check Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="health-status" class="status-indicator pending"></span>
                    <span>Platform Health Check</span>
                </h2>
                <p>Check the health of the persistence platform and CockroachDB.</p>
                <button class="test-button" onclick="testHealthCheck()">Check Health</button>
                <div id="health-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Blog Post Creation Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="create-status" class="status-indicator pending"></span>
                    <span>Blog Post Creation</span>
                </h2>
                <p>Test creating a blog post and storing it in CockroachDB.</p>
                <button class="test-button" onclick="testCreateBlogPost()">Create Test Post</button>
                <div id="create-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Blog Post Reading Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="read-status" class="status-indicator pending"></span>
                    <span>Blog Post Reading</span>
                </h2>
                <p>Test reading blog posts from CockroachDB.</p>
                <button class="test-button" onclick="testReadBlogPosts()">Read Test Posts</button>
                <div id="read-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Full Integration Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="integration-status" class="status-indicator pending"></span>
                    <span>Full Integration Test</span>
                </h2>
                <p>Run a complete CRUD cycle test for blog posts.</p>
                <button class="test-button" onclick="testFullIntegration()">Run Full Test</button>
                <div id="integration-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Navigation Links -->
            <div class="test-section">
                <h2 class="test-title">
                    <span>üîó</span>
                    <span>Blog Interface Links</span>
                </h2>
                <p>Navigate to the blog interfaces to test manually.</p>
                <a href="blog-editor.html" class="test-button">Open Blog Editor</a>
                <a href="blog-list.html" class="test-button">Open Blog List</a>
            </div>
        </main>
    </div>

    <script>
        let persistenceClient = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üß™ Blog Integration Test initialized');
            
            // Wait for persistence client
            await initializePersistenceClient();
        });

        async function initializePersistenceClient() {
            try {
                // Wait for the global persistence client to be ready
                let attempts = 0;
                while (!window.persistenceClient && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.persistenceClient) {
                    persistenceClient = window.persistenceClient;
                    updateStatus('client-status', 'success');
                    console.log('‚úÖ Persistence client ready for testing');
                } else {
                    console.warn('‚ö†Ô∏è Creating new persistence client instance');
                    persistenceClient = new window.PersistencePlatformClient();
                    updateStatus('client-status', 'success');
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize persistence client:', error);
                updateStatus('client-status', 'error');
            }
        }

        async function testPersistenceClient() {
            const resultDiv = document.getElementById('client-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Testing persistence client connection...';

            try {
                if (!persistenceClient) {
                    throw new Error('Persistence client not available');
                }

                const result = {
                    clientAvailable: !!persistenceClient,
                    clientType: persistenceClient.constructor.name,
                    endpoint: persistenceClient.endpoint || 'mock',
                    timestamp: new Date().toISOString()
                };

                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                updateStatus('client-status', 'success');
                
                console.log('‚úÖ Persistence client test passed:', result);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('client-status', 'error');
                
                console.error('‚ùå Persistence client test failed:', error);
            }
        }

        async function testHealthCheck() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Checking platform health...';

            try {
                const healthResult = await persistenceClient.checkHealth();
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(healthResult, null, 2);
                updateStatus('health-status', 'success');
                
                console.log('‚úÖ Health check passed:', healthResult);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('health-status', 'error');
                
                console.error('‚ùå Health check failed:', error);
            }
        }

        async function testCreateBlogPost() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Creating test blog post...';

            try {
                const testTitle = `Test Blog Post ${Date.now()}`;
                const testContent = `This is a test blog post created at ${new Date().toISOString()}.

## Test Content

This post tests the **persistence platform integration** with *CockroachDB*.

> This is a test quote to verify markdown rendering.

\`console.log('Test code snippet');\`

The post should be stored in CockroachDB via the persistence platform.`;

                const result = await persistenceClient.createBlogPost(
                    testTitle,
                    testContent,
                    { testPost: true, createdBy: 'integration_test' }
                );
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                updateStatus('create-status', 'success');
                
                console.log('‚úÖ Blog post creation test passed:', result);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('create-status', 'error');
                
                console.error('‚ùå Blog post creation test failed:', error);
            }
        }

        async function testReadBlogPosts() {
            const resultDiv = document.getElementById('read-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Reading blog posts...';

            try {
                const result = await persistenceClient.listBlogPosts(5, 0);
                
                const summary = {
                    success: result.success,
                    totalPosts: result.records ? result.records.length : 0,
                    executedOn: result.executedOn,
                    posts: result.records ? result.records.map(record => {
                        const data = JSON.parse(record.data);
                        return {
                            id: record.id,
                            title: data.title,
                            wordCount: data.wordCount,
                            createdAt: data.createdAt
                        };
                    }) : []
                };
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(summary, null, 2);
                updateStatus('read-status', 'success');
                
                console.log('‚úÖ Blog post reading test passed:', summary);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('read-status', 'error');
                
                console.error('‚ùå Blog post reading test failed:', error);
            }
        }

        async function testFullIntegration() {
            const resultDiv = document.getElementById('integration-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Running full integration test...\n';

            const log = (message) => {
                resultDiv.textContent += message + '\n';
            };

            try {
                // Step 1: Create a blog post
                log('1. Creating test blog post...');
                const createResult = await persistenceClient.createBlogPost(
                    `Integration Test Post ${Date.now()}`,
                    'This is a full integration test post.',
                    { integrationTest: true }
                );
                
                if (!createResult.success) {
                    throw new Error('Failed to create blog post');
                }
                
                const postId = createResult.recordId;
                log(`   ‚úÖ Created post with ID: ${postId}`);

                // Step 2: Read the blog post
                log('2. Reading the created blog post...');
                const readResult = await persistenceClient.getBlogPost(postId);
                
                if (!readResult.success || !readResult.record) {
                    throw new Error('Failed to read blog post');
                }
                
                log(`   ‚úÖ Read post: ${JSON.parse(readResult.record.data).title}`);

                // Step 3: List blog posts
                log('3. Listing all blog posts...');
                const listResult = await persistenceClient.listBlogPosts(10, 0);
                
                if (!listResult.success) {
                    throw new Error('Failed to list blog posts');
                }
                
                log(`   ‚úÖ Listed ${listResult.records.length} posts`);

                // Step 4: Delete the test post
                log('4. Deleting the test blog post...');
                const deleteResult = await persistenceClient.deleteBlogPost(postId);
                
                if (!deleteResult.success) {
                    throw new Error('Failed to delete blog post');
                }
                
                log(`   ‚úÖ Deleted post with ID: ${postId}`);

                log('\nüéâ Full integration test completed successfully!');
                
                resultDiv.className = 'test-result success';
                updateStatus('integration-status', 'success');
                
                console.log('‚úÖ Full integration test passed');

            } catch (error) {
                log(`\n‚ùå Integration test failed: ${error.message}`);
                resultDiv.className = 'test-result error';
                updateStatus('integration-status', 'error');
                
                console.error('‚ùå Full integration test failed:', error);
            }
        }

        function updateStatus(statusId, status) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.className = `status-indicator ${status}`;
            }
        }
    </script>
</body>
</html>
