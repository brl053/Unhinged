<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Blog Testing</title>
    <link rel="stylesheet" href="shared/theme.css">
    <link rel="stylesheet" href="shared/styles.css">
    <script src="shared/config.js"></script>
    <script src="../generated/static_html/registry.js"></script>
    <script src="shared/components.js"></script>
    <script src="../generated/static_html/api-clients.js"></script>
    <script src="shared/api-integration.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧪</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Navigation - Standardized Component -->
        <div id="nav-container" data-component="navigation" data-active="testing"></div>
        
        <!-- Page Header - Standardized Component -->
        <div id="header-container" data-component="page-header"
             data-title="Blog Integration Test"
             data-subtitle="End-to-End Testing"
             data-icon="🧪"></div>
        
        <!-- Main Content -->
        <main class="main-content">
<!-- Navigation -->

        <!-- Page Header -->

        <main class="test-container" id="main-content">
            <h1>🧪 Blog Integration Test</h1>
            <p>Test the blog editor and persistence platform integration with CockroachDB.</p>

            <!-- Persistence Client Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="client-status" class="status-indicator pending"></span>
                    <span>Persistence Client Connection</span>
                </h2>
                <p>Test connection to the persistence platform client.</p>
                <button class="test-button" onclick="testPersistenceClient()">Test Client Connection</button>
                <div id="client-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Health Check Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="health-status" class="status-indicator pending"></span>
                    <span>Platform Health Check</span>
                </h2>
                <p>Check the health of the persistence platform and CockroachDB.</p>
                <button class="test-button" onclick="testHealthCheck()">Check Health</button>
                <div id="health-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Blog Post Creation Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="create-status" class="status-indicator pending"></span>
                    <span>Blog Post Creation</span>
                </h2>
                <p>Test creating a blog post and storing it in CockroachDB.</p>
                <button class="test-button" onclick="testCreateBlogPost()">Create Test Post</button>
                <div id="create-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Blog Post Reading Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="read-status" class="status-indicator pending"></span>
                    <span>Blog Post Reading</span>
                </h2>
                <p>Test reading blog posts from CockroachDB.</p>
                <button class="test-button" onclick="testReadBlogPosts()">Read Test Posts</button>
                <div id="read-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Full Integration Test -->
            <div class="test-section">
                <h2 class="test-title">
                    <span id="integration-status" class="status-indicator pending"></span>
                    <span>Full Integration Test</span>
                </h2>
                <p>Run a complete CRUD cycle test for blog posts.</p>
                <button class="test-button" onclick="testFullIntegration()">Run Full Test</button>
                <div id="integration-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Navigation Links -->
            <div class="test-section">
                <h2 class="test-title">
                    <span>🔗</span>
                    <span>Blog Interface Links</span>
                </h2>
                <p>Navigate to the blog interfaces to test manually.</p>
                <a href="blog-editor.html" class="test-button">Open Blog Editor</a>
                <a href="blog-list.html" class="test-button">Open Blog List</a>
            </div>
        </main>
    </div>

    <script>
        let persistenceClient = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🧪 Blog Integration Test initialized');
            
            // Wait for persistence client
            await initializePersistenceClient();
        });

        async function initializePersistenceClient() {
            try {
                // Wait for the global persistence client to be ready
                let attempts = 0;
                while (!window.persistenceClient && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.persistenceClient) {
                    persistenceClient = window.persistenceClient;
                    updateStatus('client-status', 'success');
                    console.log('✅ Persistence client ready for testing');
                } else {
                    console.warn('⚠️ Creating new persistence client instance');
                    persistenceClient = new window.PersistencePlatformClient();
                    updateStatus('client-status', 'success');
                }
            } catch (error) {
                console.error('❌ Failed to initialize persistence client:', error);
                updateStatus('client-status', 'error');
            }
        }

        async function testPersistenceClient() {
            const resultDiv = document.getElementById('client-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Testing persistence client connection...';

            try {
                if (!persistenceClient) {
                    throw new Error('Persistence client not available');
                }

                const result = {
                    clientAvailable: !!persistenceClient,
                    clientType: persistenceClient.constructor.name,
                    endpoint: persistenceClient.endpoint || 'mock',
                    timestamp: new Date().toISOString()
                };

                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                updateStatus('client-status', 'success');
                
                console.log('✅ Persistence client test passed:', result);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('client-status', 'error');
                
                console.error('❌ Persistence client test failed:', error);
            }
        }

        async function testHealthCheck() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Checking platform health...';

            try {
                const healthResult = await persistenceClient.checkHealth();
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(healthResult, null, 2);
                updateStatus('health-status', 'success');
                
                console.log('✅ Health check passed:', healthResult);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('health-status', 'error');
                
                console.error('❌ Health check failed:', error);
            }
        }

        async function testCreateBlogPost() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Creating test blog post...';

            try {
                const testTitle = `Test Blog Post ${Date.now()}`;
                const testContent = `This is a test blog post created at ${new Date().toISOString()}.

## Test Content

This post tests the **persistence platform integration** with *CockroachDB*.

> This is a test quote to verify markdown rendering.

\`console.log('Test code snippet');\`

The post should be stored in CockroachDB via the persistence platform.`;

                const result = await persistenceClient.createBlogPost(
                    testTitle,
                    testContent,
                    { testPost: true, createdBy: 'integration_test' }
                );
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                updateStatus('create-status', 'success');
                
                console.log('✅ Blog post creation test passed:', result);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('create-status', 'error');
                
                console.error('❌ Blog post creation test failed:', error);
            }
        }

        async function testReadBlogPosts() {
            const resultDiv = document.getElementById('read-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Reading blog posts...';

            try {
                const result = await persistenceClient.listBlogPosts(5, 0);
                
                const summary = {
                    success: result.success,
                    totalPosts: result.records ? result.records.length : 0,
                    executedOn: result.executedOn,
                    posts: result.records ? result.records.map(record => {
                        const data = JSON.parse(record.data);
                        return {
                            id: record.id,
                            title: data.title,
                            wordCount: data.wordCount,
                            createdAt: data.createdAt
                        };
                    }) : []
                };
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = JSON.stringify(summary, null, 2);
                updateStatus('read-status', 'success');
                
                console.log('✅ Blog post reading test passed:', summary);

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                updateStatus('read-status', 'error');
                
                console.error('❌ Blog post reading test failed:', error);
            }
        }

        async function testFullIntegration() {
            const resultDiv = document.getElementById('integration-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = 'Running full integration test...\n';

            const log = (message) => {
                resultDiv.textContent += message + '\n';
            };

            try {
                // Step 1: Create a blog post
                log('1. Creating test blog post...');
                const createResult = await persistenceClient.createBlogPost(
                    `Integration Test Post ${Date.now()}`,
                    'This is a full integration test post.',
                    { integrationTest: true }
                );
                
                if (!createResult.success) {
                    throw new Error('Failed to create blog post');
                }
                
                const postId = createResult.recordId;
                log(`   ✅ Created post with ID: ${postId}`);

                // Step 2: Read the blog post
                log('2. Reading the created blog post...');
                const readResult = await persistenceClient.getBlogPost(postId);
                
                if (!readResult.success || !readResult.record) {
                    throw new Error('Failed to read blog post');
                }
                
                log(`   ✅ Read post: ${JSON.parse(readResult.record.data).title}`);

                // Step 3: List blog posts
                log('3. Listing all blog posts...');
                const listResult = await persistenceClient.listBlogPosts(10, 0);
                
                if (!listResult.success) {
                    throw new Error('Failed to list blog posts');
                }
                
                log(`   ✅ Listed ${listResult.records.length} posts`);

                // Step 4: Delete the test post
                log('4. Deleting the test blog post...');
                const deleteResult = await persistenceClient.deleteBlogPost(postId);
                
                if (!deleteResult.success) {
                    throw new Error('Failed to delete blog post');
                }
                
                log(`   ✅ Deleted post with ID: ${postId}`);

                log('\n🎉 Full integration test completed successfully!');
                
                resultDiv.className = 'test-result success';
                updateStatus('integration-status', 'success');
                
                console.log('✅ Full integration test passed');

            } catch (error) {
                log(`\n❌ Integration test failed: ${error.message}`);
                resultDiv.className = 'test-result error';
                updateStatus('integration-status', 'error');
                
                console.error('❌ Full integration test failed:', error);
            }
        }

        function updateStatus(statusId, status) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.className = `status-indicator ${status}`;
            }
        }
    </script>
        </main>
        
        <!-- Footer - Standardized Component -->
        <div id="footer-container" data-component="footer"></div>
    </div>
</body>
</html>