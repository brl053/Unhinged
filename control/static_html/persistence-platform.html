<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Persistence Platform</title>
    <link rel="stylesheet" href="shared/theme.css">
    <link rel="stylesheet" href="shared/styles.css">
    <script src="shared/config.js"></script>
    <script src="../generated/static_html/registry.js"></script>
    <script src="shared/components.js"></script>
    <script src="../generated/static_html/api-clients.js"></script>
    <script src="shared/api-integration.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Navigation - Standardized Component -->
        <div id="nav-container" data-component="navigation" data-active="persistence"></div>
        
        <!-- Page Header - Standardized Component -->
        <div id="header-container" data-component="page-header"
             data-title="Persistence Platform"
             data-subtitle="Database Operations"
             data-icon="üîç"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Health Monitoring Dashboard -->
            <div class="health-dashboard">
                <h2>üè• Service Health Monitoring</h2>

                <!-- Quick Status Overview -->
                <div class="status-grid">
                    <div class="status-card" id="heartbeat-status">
                        <h3>üíì Heartbeat Status</h3>
                        <div class="status-indicator" id="heartbeat-indicator">‚è≥ Checking...</div>
                        <div class="status-details" id="heartbeat-details"></div>
                    </div>

                    <div class="status-card" id="diagnostics-status">
                        <h3>üîç Diagnostics Status</h3>
                        <div class="status-indicator" id="diagnostics-indicator">‚è≥ Checking...</div>
                        <div class="status-details" id="diagnostics-details"></div>
                    </div>
                </div>

                <!-- Service Health Grid -->
                <div class="service-grid">
                    <h3>üéØ Service Health Matrix</h3>
                    <div id="service-health-grid" class="health-grid">
                        <!-- Services will be populated here -->
                    </div>
                </div>

                <!-- Health Check Controls -->
                <div class="health-controls">
                    <button id="refresh-health" class="btn btn-primary">üîÑ Refresh Health</button>
                    <button id="toggle-auto-refresh" class="btn btn-secondary">‚è∏Ô∏è Auto Refresh</button>
                    <span id="last-update">Last updated: Never</span>
                </div>

                <!-- Detailed Health Information -->
                <div class="health-details" id="health-details-panel" style="display: none;">
                    <h3>üìä Detailed Health Information</h3>
                    <pre id="health-details-content"></pre>
                </div>
            </div>

            <style>
                .health-dashboard {
                    padding: 20px;
                    max-width: 1200px;
                    margin: 0 auto;
                }

                .status-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .status-card {
                    background: var(--color-surface, #f8f9fa);
                    border: 1px solid var(--color-border, #dee2e6);
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                .status-indicator {
                    font-size: 1.2em;
                    font-weight: bold;
                    margin: 10px 0;
                }

                .status-indicator.healthy { color: #28a745; }
                .status-indicator.degraded { color: #ffc107; }
                .status-indicator.unhealthy { color: #dc3545; }
                .status-indicator.unknown { color: #6c757d; }

                .service-grid {
                    margin-bottom: 30px;
                }

                .health-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 15px;
                    margin-top: 15px;
                }

                .service-health-card {
                    background: white;
                    border: 2px solid #e9ecef;
                    border-radius: 6px;
                    padding: 15px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }

                .service-health-card:hover {
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    transform: translateY(-2px);
                }

                .service-health-card.healthy { border-color: #28a745; }
                .service-health-card.degraded { border-color: #ffc107; }
                .service-health-card.unhealthy { border-color: #dc3545; }
                .service-health-card.unknown { border-color: #6c757d; }

                .health-controls {
                    display: flex;
                    gap: 15px;
                    align-items: center;
                    margin-bottom: 20px;
                    padding: 15px;
                    background: var(--color-surface, #f8f9fa);
                    border-radius: 6px;
                }

                .btn {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 500;
                    transition: background-color 0.2s ease;
                }

                .btn-primary {
                    background-color: #007bff;
                    color: white;
                }

                .btn-primary:hover {
                    background-color: #0056b3;
                }

                .btn-secondary {
                    background-color: #6c757d;
                    color: white;
                }

                .btn-secondary:hover {
                    background-color: #545b62;
                }

                .health-details {
                    background: var(--color-surface, #f8f9fa);
                    border: 1px solid var(--color-border, #dee2e6);
                    border-radius: 6px;
                    padding: 20px;
                }

                .health-details pre {
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 4px;
                    padding: 15px;
                    overflow-x: auto;
                    font-size: 0.9em;
                    line-height: 1.4;
                }

                #last-update {
                    color: #6c757d;
                    font-size: 0.9em;
                    margin-left: auto;
                }
            </style>

            <script>
                // Health monitoring functionality
                class HealthMonitor {
                    constructor() {
                        this.autoRefresh = true;
                        this.refreshInterval = 5000; // 5 seconds
                        this.services = [
                            { name: 'Example Service', endpoint: 'http://localhost:8090', type: 'business' },
                            { name: 'Audio Service', endpoint: 'http://localhost:8080', type: 'platform' },
                            { name: 'Vision Service', endpoint: 'http://localhost:8001', type: 'platform' },
                            { name: 'LLM Service', endpoint: 'http://localhost:8080', type: 'platform' }
                        ];

                        this.init();
                    }

                    init() {
                        this.setupEventListeners();
                        this.startAutoRefresh();
                        this.refreshHealth();
                    }

                    setupEventListeners() {
                        document.getElementById('refresh-health').addEventListener('click', () => {
                            this.refreshHealth();
                        });

                        document.getElementById('toggle-auto-refresh').addEventListener('click', () => {
                            this.toggleAutoRefresh();
                        });
                    }

                    async refreshHealth() {
                        console.log('üîÑ Refreshing health status...');

                        // Update heartbeat status
                        await this.checkHeartbeat();

                        // Update diagnostics status
                        await this.checkDiagnostics();

                        // Update service grid
                        await this.updateServiceGrid();

                        // Update last refresh time
                        document.getElementById('last-update').textContent =
                            `Last updated: ${new Date().toLocaleTimeString()}`;
                    }

                    async checkHeartbeat() {
                        const indicator = document.getElementById('heartbeat-indicator');
                        const details = document.getElementById('heartbeat-details');

                        try {
                            // Simulate heartbeat check (replace with actual API call)
                            const response = await this.simulateHeartbeat();

                            indicator.textContent = `üü¢ ${response.status}`;
                            indicator.className = `status-indicator ${response.status.toLowerCase()}`;

                            details.innerHTML = `
                                <div>Service: ${response.serviceId}</div>
                                <div>Version: ${response.version}</div>
                                <div>Uptime: ${this.formatUptime(response.uptimeMs)}</div>
                            `;

                        } catch (error) {
                            indicator.textContent = 'üî¥ UNHEALTHY';
                            indicator.className = 'status-indicator unhealthy';
                            details.innerHTML = `<div>Error: ${error.message}</div>`;
                        }
                    }

                    async checkDiagnostics() {
                        const indicator = document.getElementById('diagnostics-indicator');
                        const details = document.getElementById('diagnostics-details');

                        try {
                            // Simulate diagnostics check (replace with actual API call)
                            const response = await this.simulateDiagnostics();

                            indicator.textContent = `üü¢ ${response.status}`;
                            indicator.className = `status-indicator ${response.status.toLowerCase()}`;

                            details.innerHTML = `
                                <div>Dependencies: ${response.dependencyCount}</div>
                                <div>Custom Checks: ${response.customCheckCount}</div>
                                <div>Memory Usage: ${response.memoryUsage}%</div>
                            `;

                        } catch (error) {
                            indicator.textContent = 'üî¥ FAILED';
                            indicator.className = 'status-indicator unhealthy';
                            details.innerHTML = `<div>Error: ${error.message}</div>`;
                        }
                    }

                    async updateServiceGrid() {
                        const grid = document.getElementById('service-health-grid');
                        grid.innerHTML = '';

                        for (const service of this.services) {
                            const card = await this.createServiceCard(service);
                            grid.appendChild(card);
                        }
                    }

                    async createServiceCard(service) {
                        const card = document.createElement('div');
                        card.className = 'service-health-card';

                        try {
                            // Simulate service health check
                            const health = await this.checkServiceHealth(service);

                            card.className += ` ${health.status.toLowerCase()}`;
                            card.innerHTML = `
                                <h4>${service.name}</h4>
                                <div class="status-indicator ${health.status.toLowerCase()}">
                                    ${this.getStatusIcon(health.status)} ${health.status}
                                </div>
                                <div>Response: ${health.responseTime}ms</div>
                                <div>Type: ${service.type}</div>
                            `;

                            card.addEventListener('click', () => {
                                this.showServiceDetails(service, health);
                            });

                        } catch (error) {
                            card.className += ' unknown';
                            card.innerHTML = `
                                <h4>${service.name}</h4>
                                <div class="status-indicator unknown">‚ùì UNKNOWN</div>
                                <div>Error: Connection failed</div>
                                <div>Type: ${service.type}</div>
                            `;
                        }

                        return card;
                    }

                    // Simulation methods (replace with actual API calls)
                    async simulateHeartbeat() {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return {
                            alive: true,
                            serviceId: 'example-service',
                            version: '1.0.0',
                            uptimeMs: Date.now() - (Math.random() * 3600000),
                            status: 'HEALTHY'
                        };
                    }

                    async simulateDiagnostics() {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        return {
                            status: 'HEALTHY',
                            dependencyCount: 3,
                            customCheckCount: 2,
                            memoryUsage: Math.floor(Math.random() * 80) + 10
                        };
                    }

                    async checkServiceHealth(service) {
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 300));
                        const statuses = ['HEALTHY', 'DEGRADED', 'UNHEALTHY'];
                        const status = statuses[Math.floor(Math.random() * statuses.length)];

                        return {
                            status: status,
                            responseTime: Math.floor(Math.random() * 200) + 10
                        };
                    }

                    getStatusIcon(status) {
                        switch (status.toLowerCase()) {
                            case 'healthy': return 'üü¢';
                            case 'degraded': return 'üü°';
                            case 'unhealthy': return 'üî¥';
                            default: return '‚ùì';
                        }
                    }

                    formatUptime(uptimeMs) {
                        const seconds = Math.floor(uptimeMs / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);

                        if (hours > 0) {
                            return `${hours}h ${minutes % 60}m`;
                        } else if (minutes > 0) {
                            return `${minutes}m ${seconds % 60}s`;
                        } else {
                            return `${seconds}s`;
                        }
                    }

                    showServiceDetails(service, health) {
                        const panel = document.getElementById('health-details-panel');
                        const content = document.getElementById('health-details-content');

                        content.textContent = JSON.stringify({
                            service: service,
                            health: health,
                            timestamp: new Date().toISOString()
                        }, null, 2);

                        panel.style.display = 'block';
                        panel.scrollIntoView({ behavior: 'smooth' });
                    }

                    toggleAutoRefresh() {
                        this.autoRefresh = !this.autoRefresh;
                        const button = document.getElementById('toggle-auto-refresh');

                        if (this.autoRefresh) {
                            button.textContent = '‚è∏Ô∏è Auto Refresh';
                            this.startAutoRefresh();
                        } else {
                            button.textContent = '‚ñ∂Ô∏è Auto Refresh';
                            if (this.refreshTimer) {
                                clearInterval(this.refreshTimer);
                            }
                        }
                    }

                    startAutoRefresh() {
                        if (this.refreshTimer) {
                            clearInterval(this.refreshTimer);
                        }

                        if (this.autoRefresh) {
                            this.refreshTimer = setInterval(() => {
                                this.refreshHealth();
                            }, this.refreshInterval);
                        }
                    }
                }

                // Initialize health monitor when page loads
                document.addEventListener('DOMContentLoaded', () => {
                    new HealthMonitor();
                });
            </script>
        </main>
        
        <!-- Footer - Standardized Component -->
        <div id="footer-container" data-component="footer"></div>
    </div>
</body>
</html>